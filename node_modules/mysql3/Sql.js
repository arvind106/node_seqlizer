"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isFrag = isFrag;
exports.raw = raw;
exports.selectAs = selectAs;
exports.set = set;
exports.timestamp = timestamp;
exports.point = point;
exports.polygon = polygon;
exports.escapeValue = escapeValue;
exports.escapeLike = escapeLike;
exports.escapeId = escapeId;
exports.date = date;
exports.interval = interval;
exports.sql = sql;
exports.IntervalUnit = exports.SqlFrag = void 0;

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ID_GLOBAL_REGEXP = /`/g;
const QUAL_GLOBAL_REGEXP = /\./g;

class SqlFrag {
  constructor(sql) {
    this.sql = sql;
  }

  toString() {
    throw new Error("SqlFrag cannot be cast to string");
  }

  toSqlString() {
    return this.sql;
  }

}

exports.SqlFrag = SqlFrag;

function isFrag(x) {
  return x instanceof SqlFrag;
}

function raw(...args) {
  return sql.raw(...args);
}

function selectAs(fields) {
  return new SqlFrag(Object.keys(fields).map(fieldName => `${_escapeIdLoose(fieldName)} AS ${_escapeIdStrict(fields[fieldName])}`).join(', '));
}

function set(...args) {
  return sql.set(...args);
}

function timestamp(...args) {
  return sql.timestamp(...args);
}

function point(...args) {
  return sql.point(...args);
}

function polygon(...args) {
  return sql.polygon(...args);
}

function escapeValue(value) {
  if (isFrag(value)) return value;
  return new SqlFrag(_escapeValue(value));
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function escapeLike(value, escChar = '\\') {
  if (escChar.length !== 1 || escChar === '%' || escChar === '_') throw new Error("Bad escape char");
  return value.replace(new RegExp(`[%_${escapeRegExp(escChar)}]`, 'g'), m => escChar + m);
}

function _escapeValue(value) {
  if (isFrag(value)) {
    return value.toSqlString();
  }

  if (Array.isArray(value)) {
    if (!value.length) return '/*empty*/NULL';
    return value.map(v => _escapeValue(v)).join(',');
  }

  if (Buffer.isBuffer(value)) {
    return `x'${value.toString('hex')}'`;
  }

  if (typeof value === 'number' || typeof value === 'bigint') {
    return String(value);
  }

  if (typeof value === 'string') {
    return _escapeString(value);
  }

  if (value === true) {
    return '1';
  }

  if (value === false) {
    return '0';
  }

  if (value === null) {
    return 'NULL';
  }

  throw new Error(`Unsupported value type: ${value}`);
}

const CHARS_REGEX = /[\x00\b\n\r\t\x1A'\\]/gu;
const CHARS_ESCAPE_MAP = {
  '\0': '\\0',
  '\b': '\\b',
  '\n': '\\n',
  '\r': '\\r',
  '\t': '\\t',
  '\x1a': '\\Z',
  '\'': "''",
  '\\': '\\\\'
};

function _escapeString(value) {
  return "'" + String(value).replace(CHARS_REGEX, m => CHARS_ESCAPE_MAP[m]) + "'";
}

function escapeId(id) {
  if (isFrag(id)) return id;
  if (Array.isArray(id)) return new SqlFrag(id.map(_escapeIdStrict).join('.'));
  return new SqlFrag(_escapeIdStrict(id));
}

function _escapeIdLoose(id) {
  if (isFrag(id)) return id.toSqlString();
  if (Array.isArray(id)) return id.map(_escapeIdStrict).join('.');
  return '`' + String(id).replace(ID_GLOBAL_REGEXP, '``').replace(QUAL_GLOBAL_REGEXP, '`.`') + '`';
}

function _escapeIdStrict(id) {
  if (isFrag(id)) return id.toSqlString();
  if (Array.isArray(id)) return id.map(_escapeIdStrict).join('.');
  return '`' + String(id).replace(ID_GLOBAL_REGEXP, '``') + '`';
}

function date(value, outputTimezone, inputTimezone) {
  const date = makeMoment(value, outputTimezone, inputTimezone);
  return new SqlFrag(`DATE'${date.format('YYYY-MM-DD')}'`);
}

function makeMoment(value, outputTimezone, inputTimezone) {
  let d;

  if (inputTimezone) {
    const zone = _momentTimezone.default.tz.zone(inputTimezone);

    if (!zone) throw new Error(`Invalid input timezone: ${inputTimezone}`);
    d = _momentTimezone.default.tz(value, zone.name);
  } else {
    d = (0, _momentTimezone.default)(value);
  }

  if (!d.isValid()) {
    throw new Error(`Input date is not valid`);
  }

  if (outputTimezone) {
    const zone = _momentTimezone.default.tz.zone(outputTimezone);

    if (!zone) throw new Error(`Invalid output timezone: ${outputTimezone}`);
    d.tz(zone.name);
  }

  return d;
}

function hasOwn(obj, key) {
  return Object.prototype.hasOwnProperty.call(obj, key);
}

function toPairs(points) {
  if (!points.length) return [];
  const sample = points[0];

  if (Array.isArray(sample) && sample.length === 2) {
    return [...points];
  }

  if (hasOwn(sample, 'x') && hasOwn(sample, 'y')) {
    return points.map(pt => [pt.x, pt.y]);
  }

  if (hasOwn(sample, 'lat') && hasOwn(sample, 'lng')) {
    return points.map(pt => [pt.lat, pt.lng]);
  }

  throw new Error("Points are not in an expected format");
}

let IntervalUnit;
exports.IntervalUnit = IntervalUnit;

(function (IntervalUnit) {
  IntervalUnit["MICROSECOND"] = "MICROSECOND";
  IntervalUnit["MILLISECOND"] = "MILLISECOND";
  IntervalUnit["SECOND"] = "SECOND";
  IntervalUnit["MINUTE"] = "MINUTE";
  IntervalUnit["HOUR"] = "HOUR";
  IntervalUnit["DAY"] = "DAY";
  IntervalUnit["WEEK"] = "WEEK";
  IntervalUnit["MONTH"] = "MONTH";
  IntervalUnit["QUARTER"] = "QUARTER";
  IntervalUnit["YEAR"] = "YEAR";
})(IntervalUnit || (exports.IntervalUnit = IntervalUnit = {}));

function interval(value, unit = IntervalUnit.MILLISECOND) {
  if (unit === IntervalUnit.MILLISECOND) {
    value *= 1000;
    unit = IntervalUnit.MICROSECOND;
  }

  return new SqlFrag(`INTERVAL ${Math.round(value)} ${unit}`);
}

function sql(strings, ...values) {
  let out = [];
  let i = 0;

  for (; i < values.length; ++i) {
    out.push(strings[i], escapeValue(values[i]).toSqlString());
  }

  out.push(strings[i]);
  return new SqlFrag(out.join(''));
}

(function (_sql) {
  function set(fields) {
    if (Array.isArray(fields)) {
      return new SqlFrag(fields.map(f => `${escapeId(f[0]).toSqlString()}=${escapeValue(f[1]).toSqlString()}`).join(', '));
    }

    return new SqlFrag(Object.keys(fields).map(fieldName => `${_escapeIdLoose(fieldName)}=${escapeValue(fields[fieldName]).toSqlString()}`).join(', '));
  }

  _sql.set = set;

  function insert(table, data, options) {
    let q = sql`INSERT ${sql.raw((options == null ? void 0 : options.ignore) ? 'IGNORE ' : '')}INTO ${escapeId(table)} SET ${sql.set(data)}`;

    if (options == null ? void 0 : options.ignoreDupes) {
      if (options == null ? void 0 : options.updateOnDupe) {
        throw new Error("`ignoreDupes` and `updateOnDupe` are incompatible");
      }

      let firstCol;

      if (Array.isArray(data)) {
        firstCol = data[0][0];
      } else {
        firstCol = Object.keys(data)[0];
      }

      const escCol = new SqlFrag(_escapeIdLoose(firstCol));
      q = sql`${q} ON DUPLICATE KEY UPDATE ${escCol}=VALUES(${escCol})`;
    }

    if (options == null ? void 0 : options.updateOnDupe) {
      let cols;

      if (Array.isArray(data)) {
        cols = data.map(f => f[0]);
      } else {
        cols = Object.keys(data);
      }

      q = sql`${q} ON DUPLICATE KEY UPDATE ${cols.map(col => {
        const escCol = new SqlFrag(_escapeIdLoose(col));
        return sql`${escCol}=VALUES(${escCol})`;
      })}`;
    }

    return q;
  }

  _sql.insert = insert;

  function as(fields) {
    if (Array.isArray(fields)) {
      return new SqlFrag(fields.map(f => `${escapeId(f[0]).toSqlString()} AS ${_escapeString(f[1])}`).join(', '));
    }

    return new SqlFrag(Object.keys(fields).map(alias => `${_escapeIdStrict(fields[alias])} AS ${_escapeString(alias)}`).join(', '));
  }

  _sql.as = as;

  function raw(sqlString) {
    if (sqlString instanceof SqlFrag) return sqlString;
    return new SqlFrag(sqlString);
  }

  _sql.raw = raw;

  function timestamp(value, outputTimezone, inputTimezone, fsp) {
    const date = makeMoment(value, outputTimezone, inputTimezone);
    let frac = '';

    if (fsp != null) {
      if (fsp < 0 || fsp > 6) {
        throw new Error(`fsp out of range: ${fsp}`);
      } else if (fsp > 0) {
        frac = '.' + 'S'.repeat(fsp);
      }
    } else if (date.milliseconds() !== 0) {
      frac = '.SSS';
    }

    return new SqlFrag(`TIMESTAMP'${date.format(`YYYY-MM-DD HH:mm:ss${frac}`)}'`);
  }

  _sql.timestamp = timestamp;

  function point(x, y) {
    return sql`PointFromText(${`POINT(${x} ${y})`})`;
  }

  _sql.point = point;

  function polygon(points, autoComplete = true) {
    if (!points.length) throw new Error("Cannot create an empty polygon");
    points = toPairs(points);

    if (autoComplete) {
      const l = points.length - 1;

      if (!(points[0][0] === points[l][0] && points[0][1] === points[l][1])) {
        points.push([points[0][0], points[0][1]]);
      }
    }

    return sql`PolyFromText(${`POLYGON((${points.map(([x, y]) => `${x} ${y}`).join(',')}))`})`;
  }

  _sql.polygon = polygon;

  function id(id) {
    return escapeId(id);
  }

  _sql.id = id;

  function db(id) {
    return escapeId(id);
  }

  _sql.db = db;

  function tbl(id) {
    return escapeId(id);
  }

  _sql.tbl = tbl;

  function col(id) {
    return escapeId(id);
  }

  _sql.col = col;

  function columns(columns) {
    return new SqlFrag(columns.map(_escapeIdStrict).join(', '));
  }

  _sql.columns = columns;

  function values(values) {
    return new SqlFrag(values.map(row => `(${row.map(_escapeValue).join(',')})`).join(',\n'));
  }

  _sql.values = values;
})(sql || (exports.sql = sql = {}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcWwudHMiXSwibmFtZXMiOlsiSURfR0xPQkFMX1JFR0VYUCIsIlFVQUxfR0xPQkFMX1JFR0VYUCIsIlNxbEZyYWciLCJjb25zdHJ1Y3RvciIsInNxbCIsInRvU3RyaW5nIiwiRXJyb3IiLCJ0b1NxbFN0cmluZyIsImlzRnJhZyIsIngiLCJyYXciLCJhcmdzIiwic2VsZWN0QXMiLCJmaWVsZHMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwiZmllbGROYW1lIiwiX2VzY2FwZUlkTG9vc2UiLCJfZXNjYXBlSWRTdHJpY3QiLCJqb2luIiwic2V0IiwidGltZXN0YW1wIiwicG9pbnQiLCJwb2x5Z29uIiwiZXNjYXBlVmFsdWUiLCJ2YWx1ZSIsIl9lc2NhcGVWYWx1ZSIsImVzY2FwZVJlZ0V4cCIsInN0cmluZyIsInJlcGxhY2UiLCJlc2NhcGVMaWtlIiwiZXNjQ2hhciIsImxlbmd0aCIsIlJlZ0V4cCIsIm0iLCJBcnJheSIsImlzQXJyYXkiLCJ2IiwiQnVmZmVyIiwiaXNCdWZmZXIiLCJTdHJpbmciLCJfZXNjYXBlU3RyaW5nIiwiQ0hBUlNfUkVHRVgiLCJDSEFSU19FU0NBUEVfTUFQIiwiZXNjYXBlSWQiLCJpZCIsImRhdGUiLCJvdXRwdXRUaW1lem9uZSIsImlucHV0VGltZXpvbmUiLCJtYWtlTW9tZW50IiwiZm9ybWF0IiwiZCIsInpvbmUiLCJtb21lbnQiLCJ0eiIsIm5hbWUiLCJpc1ZhbGlkIiwiaGFzT3duIiwib2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwidG9QYWlycyIsInBvaW50cyIsInNhbXBsZSIsInB0IiwieSIsImxhdCIsImxuZyIsIkludGVydmFsVW5pdCIsImludGVydmFsIiwidW5pdCIsIk1JTExJU0VDT05EIiwiTUlDUk9TRUNPTkQiLCJNYXRoIiwicm91bmQiLCJzdHJpbmdzIiwidmFsdWVzIiwib3V0IiwiaSIsInB1c2giLCJmIiwiaW5zZXJ0IiwidGFibGUiLCJkYXRhIiwib3B0aW9ucyIsInEiLCJpZ25vcmUiLCJpZ25vcmVEdXBlcyIsInVwZGF0ZU9uRHVwZSIsImZpcnN0Q29sIiwiZXNjQ29sIiwiY29scyIsImNvbCIsImFzIiwiYWxpYXMiLCJzcWxTdHJpbmciLCJmc3AiLCJmcmFjIiwicmVwZWF0IiwibWlsbGlzZWNvbmRzIiwiYXV0b0NvbXBsZXRlIiwibCIsImRiIiwidGJsIiwiY29sdW1ucyIsInJvdyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUVBLE1BQU1BLGdCQUFnQixHQUFHLElBQXpCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsS0FBM0I7O0FBRU8sTUFBTUMsT0FBTixDQUFjO0FBQ2pCQyxFQUFBQSxXQUFXLENBQWtCQyxHQUFsQixFQUErQjtBQUFBLFNBQWJBLEdBQWEsR0FBYkEsR0FBYTtBQUN6Qzs7QUFFREMsRUFBQUEsUUFBUSxHQUFHO0FBQ1AsVUFBTSxJQUFJQyxLQUFKLENBQVUsa0NBQVYsQ0FBTjtBQUNIOztBQUVEQyxFQUFBQSxXQUFXLEdBQUc7QUFDVixXQUFPLEtBQUtILEdBQVo7QUFDSDs7QUFWZ0I7Ozs7QUFhZCxTQUFTSSxNQUFULENBQWdCQyxDQUFoQixFQUFzQztBQUN6QyxTQUFPQSxDQUFDLFlBQVlQLE9BQXBCO0FBQ0g7O0FBS00sU0FBU1EsR0FBVCxDQUFhLEdBQUdDLElBQWhCLEVBQWtEO0FBQ3JELFNBQU9QLEdBQUcsQ0FBQ00sR0FBSixDQUFRLEdBQUdDLElBQVgsQ0FBUDtBQUNIOztBQUtNLFNBQVNDLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTJEO0FBQzlELFNBQU8sSUFBSVgsT0FBSixDQUFZWSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsTUFBWixFQUFvQkcsR0FBcEIsQ0FBd0JDLFNBQVMsSUFBSyxHQUFFQyxjQUFjLENBQUNELFNBQUQsQ0FBWSxPQUFNRSxlQUFlLENBQUNOLE1BQU0sQ0FBQ0ksU0FBRCxDQUFQLENBQW9CLEVBQTNHLEVBQThHRyxJQUE5RyxDQUFtSCxJQUFuSCxDQUFaLENBQVA7QUFD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NUQsRUFBYixFQUFtQztBQUN0QyxXQUFPRCxRQUFRLENBQUNDLEVBQUQsQ0FBZjtBQUNIOzs7O0FBQ00sV0FBU2lELEdBQVQsQ0FBYWpELEVBQWIsRUFBb0M7QUFDdkMsV0FBT0QsUUFBUSxDQUFDQyxFQUFELENBQWY7QUFDSDs7OztBQUNNLFdBQVM2RCxPQUFULENBQWlCQSxPQUFqQixFQUF5QztBQUM1QyxXQUFPLElBQUl6RyxPQUFKLENBQVl5RyxPQUFPLENBQUMzRixHQUFSLENBQVlHLGVBQVosRUFBNkJDLElBQTdCLENBQWtDLElBQWxDLENBQVosQ0FBUDtBQUNIOzs7O0FBQ00sV0FBUzJELE1BQVQsQ0FBZ0JBLE1BQWhCLEVBQTRDO0FBQy9DLFdBQU8sSUFBSTdFLE9BQUosQ0FBWTZFLE1BQU0sQ0FBQy9ELEdBQVAsQ0FBVzRGLEdBQUcsSUFBSyxJQUFHQSxHQUFHLENBQUM1RixHQUFKLENBQVFXLFlBQVIsRUFBc0JQLElBQXRCLENBQTJCLEdBQTNCLENBQWdDLEdBQXRELEVBQTBEQSxJQUExRCxDQUErRCxLQUEvRCxDQUFaLENBQVA7QUFDSDs7O0dBcEdZaEIsRyxtQkFBQUEsRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50LXRpbWV6b25lJztcblxuY29uc3QgSURfR0xPQkFMX1JFR0VYUCA9IC9gL2c7XG5jb25zdCBRVUFMX0dMT0JBTF9SRUdFWFAgPSAvXFwuL2c7XG5cbmV4cG9ydCBjbGFzcyBTcWxGcmFnIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNxbDogc3RyaW5nKSB7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNxbEZyYWcgY2Fubm90IGJlIGNhc3QgdG8gc3RyaW5nXCIpO1xuICAgIH1cblxuICAgIHRvU3FsU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zcWw7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGcmFnKHg6IGFueSk6IHggaXMgU3FsRnJhZyB7XG4gICAgcmV0dXJuIHggaW5zdGFuY2VvZiBTcWxGcmFnO1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByYXcoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2Ygc3FsLnJhdz4pIHtcbiAgICByZXR1cm4gc3FsLnJhdyguLi5hcmdzKTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBVc2Ugc3FsLmFzIGluc3RlYWQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3RBcyhmaWVsZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pOiBTcWxGcmFnIHtcbiAgICByZXR1cm4gbmV3IFNxbEZyYWcoT2JqZWN0LmtleXMoZmllbGRzKS5tYXAoZmllbGROYW1lID0+IGAke19lc2NhcGVJZExvb3NlKGZpZWxkTmFtZSl9IEFTICR7X2VzY2FwZUlkU3RyaWN0KGZpZWxkc1tmaWVsZE5hbWVdKX1gKS5qb2luKCcsICcpKTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0KC4uLmFyZ3M6IFBhcmFtZXRlcnM8dHlwZW9mIHNxbC5zZXQ+KSB7XG4gICAgcmV0dXJuIHNxbC5zZXQoLi4uYXJncyk7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRpbWVzdGFtcCguLi5hcmdzOiBQYXJhbWV0ZXJzPHR5cGVvZiBzcWwudGltZXN0YW1wPikge1xuICAgIHJldHVybiBzcWwudGltZXN0YW1wKC4uLmFyZ3MpO1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwb2ludCguLi5hcmdzOiBQYXJhbWV0ZXJzPHR5cGVvZiBzcWwucG9pbnQ+KSB7XG4gICAgcmV0dXJuIHNxbC5wb2ludCguLi5hcmdzKTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gcG9seWdvbiguLi5hcmdzOiBQYXJhbWV0ZXJzPHR5cGVvZiBzcWwucG9seWdvbj4pIHtcbiAgICByZXR1cm4gc3FsLnBvbHlnb24oLi4uYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlc2NhcGVWYWx1ZSh2YWx1ZTogVmFsdWUpOiBTcWxGcmFnIHtcbiAgICBpZiAoaXNGcmFnKHZhbHVlKSkgcmV0dXJuIHZhbHVlO1xuICAgIHJldHVybiBuZXcgU3FsRnJhZyhfZXNjYXBlVmFsdWUodmFsdWUpKTtcbn1cblxuZnVuY3Rpb24gZXNjYXBlUmVnRXhwKHN0cmluZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7IC8vICQmIG1lYW5zIHRoZSB3aG9sZSBtYXRjaGVkIHN0cmluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXNjYXBlTGlrZSh2YWx1ZTogc3RyaW5nLCBlc2NDaGFyOnN0cmluZyA9ICdcXFxcJyk6IHN0cmluZyB7XG4gICAgaWYoZXNjQ2hhci5sZW5ndGggIT09IDEgfHwgZXNjQ2hhciA9PT0gJyUnIHx8IGVzY0NoYXIgPT09ICdfJykgdGhyb3cgbmV3IEVycm9yKFwiQmFkIGVzY2FwZSBjaGFyXCIpO1xuICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKG5ldyBSZWdFeHAoYFslXyR7ZXNjYXBlUmVnRXhwKGVzY0NoYXIpfV1gLCdnJyksIG0gPT4gZXNjQ2hhciArIG0pO1xufVxuXG5mdW5jdGlvbiBfZXNjYXBlVmFsdWUodmFsdWU6IFZhbHVlKTogc3RyaW5nIHtcbiAgICBpZiAoaXNGcmFnKHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gdmFsdWUudG9TcWxTdHJpbmcoKTtcbiAgICB9XG4gICAgaWYoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgaWYoIXZhbHVlLmxlbmd0aCkgcmV0dXJuICcvKmVtcHR5Ki9OVUxMJ1xuICAgICAgICByZXR1cm4gdmFsdWUubWFwKHYgPT4gX2VzY2FwZVZhbHVlKHYpKS5qb2luKCcsJyk7XG4gICAgfVxuICAgIGlmKEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIGB4JyR7dmFsdWUudG9TdHJpbmcoJ2hleCcpfSdgO1xuICAgIH1cbiAgICBpZih0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2JpZ2ludCcpIHtcbiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG4gICAgfVxuICAgIGlmKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIF9lc2NhcGVTdHJpbmcodmFsdWUpO1xuICAgIH1cbiAgICBpZih2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gJzEnO1xuICAgIH1cbiAgICBpZih2YWx1ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuICcwJztcbiAgICB9XG4gICAgaWYodmFsdWUgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuICdOVUxMJztcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCB2YWx1ZSB0eXBlOiAke3ZhbHVlfWApXG59XG5cbmNvbnN0IENIQVJTX1JFR0VYID0gL1tcXHgwMFxcYlxcblxcclxcdFxceDFBJ1xcXFxdL2d1O1xuY29uc3QgQ0hBUlNfRVNDQVBFX01BUDogUmVjb3JkPHN0cmluZyxzdHJpbmc+ID0ge1xuICAgICdcXDAnOiAnXFxcXDAnLFxuICAgICdcXGInOiAnXFxcXGInLFxuICAgICdcXG4nOiAnXFxcXG4nLFxuICAgICdcXHInOiAnXFxcXHInLFxuICAgICdcXHQnOiAnXFxcXHQnLFxuICAgICdcXHgxYSc6ICdcXFxcWicsXG4gICAgJ1xcJyc6IFwiJydcIixcbiAgICAnXFxcXCc6ICdcXFxcXFxcXCdcbn07XG5cbmZ1bmN0aW9uIF9lc2NhcGVTdHJpbmcodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFwiJ1wiICsgU3RyaW5nKHZhbHVlKS5yZXBsYWNlKENIQVJTX1JFR0VYLG0gPT4gQ0hBUlNfRVNDQVBFX01BUFttXSkgKyBcIidcIjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVzY2FwZUlkKGlkOiBJZCk6IFNxbEZyYWcge1xuICAgIGlmIChpc0ZyYWcoaWQpKSByZXR1cm4gaWQ7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaWQpKSByZXR1cm4gbmV3IFNxbEZyYWcoaWQubWFwKF9lc2NhcGVJZFN0cmljdCkuam9pbignLicpKTtcbiAgICByZXR1cm4gbmV3IFNxbEZyYWcoX2VzY2FwZUlkU3RyaWN0KGlkKSk7XG59XG5cbmZ1bmN0aW9uIF9lc2NhcGVJZExvb3NlKGlkOiBJZCk6IHN0cmluZyB7XG4gICAgaWYoaXNGcmFnKGlkKSkgcmV0dXJuIGlkLnRvU3FsU3RyaW5nKCk7XG4gICAgaWYoQXJyYXkuaXNBcnJheShpZCkpIHJldHVybiBpZC5tYXAoX2VzY2FwZUlkU3RyaWN0KS5qb2luKCcuJyk7XG4gICAgcmV0dXJuICdgJyArIFN0cmluZyhpZCkucmVwbGFjZShJRF9HTE9CQUxfUkVHRVhQLCAnYGAnKS5yZXBsYWNlKFFVQUxfR0xPQkFMX1JFR0VYUCwgJ2AuYCcpICsgJ2AnO1xufVxuXG5mdW5jdGlvbiBfZXNjYXBlSWRTdHJpY3QoaWQ6IElkKTogc3RyaW5nIHtcbiAgICBpZihpc0ZyYWcoaWQpKSByZXR1cm4gaWQudG9TcWxTdHJpbmcoKTtcbiAgICBpZihBcnJheS5pc0FycmF5KGlkKSkgcmV0dXJuIGlkLm1hcChfZXNjYXBlSWRTdHJpY3QpLmpvaW4oJy4nKTtcbiAgICByZXR1cm4gJ2AnICsgU3RyaW5nKGlkKS5yZXBsYWNlKElEX0dMT0JBTF9SRUdFWFAsICdgYCcpICsgJ2AnO1xufVxuXG50eXBlIFNpbmdsZVVuZXNjYXBlZFZhbHVlID0gc3RyaW5nIHwgbnVtYmVyIHwgQnVmZmVyIHwgYmlnaW50IHwgYm9vbGVhbiB8IG51bGw7XG50eXBlIFVuZXNjYXBlZFZhbHVlID0gU2luZ2xlVW5lc2NhcGVkVmFsdWV8U2luZ2xlVW5lc2NhcGVkVmFsdWVbXVxudHlwZSBTaW5nbGVWYWx1ZSA9IFNpbmdsZVVuZXNjYXBlZFZhbHVlfFNxbEZyYWdcbnR5cGUgVmFsdWUgPSBTaW5nbGVWYWx1ZXxTaW5nbGVWYWx1ZVtdO1xudHlwZSBEYXRhYmFzZUlkID0gc3RyaW5nfFtzdHJpbmddXG50eXBlIFRhYmxlSWQgPSBzdHJpbmd8W3N0cmluZ118W3N0cmluZyxzdHJpbmddXG50eXBlIENvbHVtbklkID0gIHN0cmluZ3xbc3RyaW5nXXxbc3RyaW5nLHN0cmluZ118W3N0cmluZyxzdHJpbmcsc3RyaW5nXTtcbnR5cGUgVW5lc2NhcGVkSWQgPSBDb2x1bW5JZDtcbnR5cGUgSWQgPSBVbmVzY2FwZWRJZHxTcWxGcmFnO1xuXG5leHBvcnQgZnVuY3Rpb24gZGF0ZSh2YWx1ZTogRGF0ZSB8IHN0cmluZyB8IG51bWJlciB8IG1vbWVudC5Nb21lbnQsIG91dHB1dFRpbWV6b25lPzogc3RyaW5nLCBpbnB1dFRpbWV6b25lPzogc3RyaW5nKTogU3FsRnJhZyB7XG4gICAgLy8gaHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL2RhdGUtYW5kLXRpbWUtbGl0ZXJhbHMuaHRtbFxuICAgIGNvbnN0IGRhdGUgPSBtYWtlTW9tZW50KHZhbHVlLCBvdXRwdXRUaW1lem9uZSwgaW5wdXRUaW1lem9uZSk7XG4gICAgcmV0dXJuIG5ldyBTcWxGcmFnKGBEQVRFJyR7ZGF0ZS5mb3JtYXQoJ1lZWVktTU0tREQnKX0nYClcbn1cblxudHlwZSBuaWwgPSBudWxsIHwgdW5kZWZpbmVkO1xuXG5mdW5jdGlvbiBtYWtlTW9tZW50KHZhbHVlOiBtb21lbnQuTW9tZW50SW5wdXQsIG91dHB1dFRpbWV6b25lPzogc3RyaW5nIHwgbnVsbCwgaW5wdXRUaW1lem9uZT86IHN0cmluZyB8IG51bGwpOiBtb21lbnQuTW9tZW50IHtcbiAgICBsZXQgZDtcbiAgICBpZiAoaW5wdXRUaW1lem9uZSkge1xuICAgICAgICBjb25zdCB6b25lID0gbW9tZW50LnR6LnpvbmUoaW5wdXRUaW1lem9uZSk7XG4gICAgICAgIGlmICghem9uZSkgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGlucHV0IHRpbWV6b25lOiAke2lucHV0VGltZXpvbmV9YCk7XG4gICAgICAgIGQgPSBtb21lbnQudHoodmFsdWUsIHpvbmUubmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZCA9IG1vbWVudCh2YWx1ZSk7XG4gICAgfVxuICAgIGlmICghZC5pc1ZhbGlkKCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dCBkYXRlIGlzIG5vdCB2YWxpZGApO1xuICAgIH1cbiAgICBpZiAob3V0cHV0VGltZXpvbmUpIHtcbiAgICAgICAgY29uc3Qgem9uZSA9IG1vbWVudC50ei56b25lKG91dHB1dFRpbWV6b25lKTtcbiAgICAgICAgaWYgKCF6b25lKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb3V0cHV0IHRpbWV6b25lOiAke291dHB1dFRpbWV6b25lfWApO1xuICAgICAgICBkLnR6KHpvbmUubmFtZSlcbiAgICB9XG4gICAgcmV0dXJuIGQ7XG59XG5cbmludGVyZmFjZSBQb2ludCB7XG4gICAgeDogbnVtYmVyXG4gICAgeTogbnVtYmVyXG59XG5cbmludGVyZmFjZSBMYXRMbmcge1xuICAgIGxhdDogbnVtYmVyXG4gICAgbG5nOiBudW1iZXJcbn1cblxudHlwZSBOdW1iZXJQYWlyID0gW251bWJlciwgbnVtYmVyXVxudHlwZSBQb2ludEFycmF5ID0gTnVtYmVyUGFpcltdIHwgUG9pbnRbXSB8IExhdExuZ1tdXG5cbmZ1bmN0aW9uIGhhc093bihvYmo6IG9iamVjdCwga2V5OiBQcm9wZXJ0eUtleSkge1xuICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpO1xufVxuXG5mdW5jdGlvbiB0b1BhaXJzKHBvaW50czogUG9pbnRBcnJheSk6IE51bWJlclBhaXJbXSB7XG4gICAgaWYgKCFwb2ludHMubGVuZ3RoKSByZXR1cm4gW107XG4gICAgY29uc3Qgc2FtcGxlID0gcG9pbnRzWzBdO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHNhbXBsZSkgJiYgc2FtcGxlLmxlbmd0aCA9PT0gMikge1xuICAgICAgICByZXR1cm4gWy4uLnBvaW50c10gYXMgTnVtYmVyUGFpcltdO1xuICAgIH1cbiAgICBpZiAoaGFzT3duKHNhbXBsZSwgJ3gnKSAmJiBoYXNPd24oc2FtcGxlLCAneScpKSB7XG4gICAgICAgIHJldHVybiAocG9pbnRzIGFzIFBvaW50W10pLm1hcChwdCA9PiBbcHQueCwgcHQueV0pO1xuICAgIH1cbiAgICBpZiAoaGFzT3duKHNhbXBsZSwgJ2xhdCcpICYmIGhhc093bihzYW1wbGUsICdsbmcnKSkge1xuICAgICAgICByZXR1cm4gKHBvaW50cyBhcyBMYXRMbmdbXSkubWFwKHB0ID0+IFtwdC5sYXQsIHB0LmxuZ10pO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJQb2ludHMgYXJlIG5vdCBpbiBhbiBleHBlY3RlZCBmb3JtYXRcIilcbn1cblxuXG4vKipcbiAqIEBkZXByZWNhdGVkIEV4cGVyaW1lbnRhbC5cbiAqL1xuZXhwb3J0IGVudW0gSW50ZXJ2YWxVbml0IHtcbiAgICAvLyBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi84LjAvZW4vZXhwcmVzc2lvbnMuaHRtbFxuICAgIE1JQ1JPU0VDT05EID0gJ01JQ1JPU0VDT05EJyxcbiAgICBNSUxMSVNFQ09ORCA9ICdNSUxMSVNFQ09ORCcsXG4gICAgU0VDT05EID0gJ1NFQ09ORCcsXG4gICAgTUlOVVRFID0gJ01JTlVURScsXG4gICAgSE9VUiA9ICdIT1VSJyxcbiAgICBEQVkgPSAnREFZJyxcbiAgICBXRUVLID0gJ1dFRUsnLFxuICAgIE1PTlRIID0gJ01PTlRIJyxcbiAgICBRVUFSVEVSID0gJ1FVQVJURVInLFxuICAgIFlFQVIgPSAnWUVBUicsXG4gICAgLy8gVE9ETzogc3VwcG9ydCB0aGUgb3RoZXIgY29tcG91bmQgdHlwZXMuXG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgRXhwZXJpbWVudGFsLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaW50ZXJ2YWwodmFsdWU6bnVtYmVyLCB1bml0OkludGVydmFsVW5pdD1JbnRlcnZhbFVuaXQuTUlMTElTRUNPTkQpOiBTcWxGcmFnIHtcbiAgICAvLyBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi84LjAvZW4vZXhwcmVzc2lvbnMuaHRtbFxuICAgIGlmKHVuaXQgPT09IEludGVydmFsVW5pdC5NSUxMSVNFQ09ORCkge1xuICAgICAgICAvLyBNaWxsaXNlY29uZCBkb2Vzbid0IGFjdHVhbGx5IGV4aXN0IGluIE15U1FMIGZvciBzb21lIHJlYXNvbi5cbiAgICAgICAgdmFsdWUgKj0gMTAwMFxuICAgICAgICB1bml0ID0gSW50ZXJ2YWxVbml0Lk1JQ1JPU0VDT05EO1xuICAgIH1cbiAgICAvLyBJbnRlcnZhbHMgYXBwZWFyIHRvIGJlIHJvdW5kZWQgaW4gTXlTUUxcbiAgICAvLyBTRUxFQ1QgVElNRScxMjowMDowMCcgKyBJTlRFUlZBTCAxLjUgSE9VUiAtLSAxNDowMDowMFxuICAgIHJldHVybiBuZXcgU3FsRnJhZyhgSU5URVJWQUwgJHtNYXRoLnJvdW5kKHZhbHVlKX0gJHt1bml0fWApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3FsKHN0cmluZ3M6IFRlbXBsYXRlU3RyaW5nc0FycmF5LCAuLi52YWx1ZXM6IFZhbHVlW10pOiBTcWxGcmFnIHtcbiAgICBsZXQgb3V0ID0gW107XG4gICAgbGV0IGkgPSAwO1xuICAgIGZvciAoOyBpIDwgdmFsdWVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIG91dC5wdXNoKHN0cmluZ3NbaV0sIGVzY2FwZVZhbHVlKHZhbHVlc1tpXSkudG9TcWxTdHJpbmcoKSk7XG4gICAgfVxuICAgIG91dC5wdXNoKHN0cmluZ3NbaV0pO1xuICAgIHJldHVybiBuZXcgU3FsRnJhZyhvdXQuam9pbignJykpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEluc2VydE9wdGlvbnMge1xuICAgIC8qKlxuICAgICAqIElnbm9yZSBkdXBsaWNhdGUgcmVjb3Jkcy5cbiAgICAgKi9cbiAgICBpZ25vcmVEdXBlcz86IGJvb2xlYW5cbiAgICB1cGRhdGVPbkR1cGU/OiBib29sZWFuXG4gICAgaWdub3JlPzogYm9vbGVhblxufVxuXG5leHBvcnQgbmFtZXNwYWNlIHNxbCB7XG4gICAgZXhwb3J0IGZ1bmN0aW9uIHNldChmaWVsZHM6IFJlY29yZDxzdHJpbmcsIFZhbHVlPnxBcnJheTxbSWQsVmFsdWVdPik6IFNxbEZyYWcge1xuICAgICAgICBpZihBcnJheS5pc0FycmF5KGZpZWxkcykpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhmaWVsZHMubWFwKGYgPT4gYCR7ZXNjYXBlSWQoZlswXSkudG9TcWxTdHJpbmcoKX09JHtlc2NhcGVWYWx1ZShmWzFdKS50b1NxbFN0cmluZygpfWApLmpvaW4oJywgJykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhPYmplY3Qua2V5cyhmaWVsZHMpLm1hcChmaWVsZE5hbWUgPT4gYCR7X2VzY2FwZUlkTG9vc2UoZmllbGROYW1lKX09JHtlc2NhcGVWYWx1ZShmaWVsZHNbZmllbGROYW1lXSkudG9TcWxTdHJpbmcoKX1gKS5qb2luKCcsICcpKTtcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIGluc2VydDxTY2hlbWEgZXh0ZW5kcyBvYmplY3Q9UmVjb3JkPHN0cmluZywgVmFsdWU+Pih0YWJsZTogSWQsIGRhdGE6IFBhcnRpYWw8U2NoZW1hPnxBcnJheTxbSWQsVmFsdWVdPiwgb3B0aW9ucz86IEluc2VydE9wdGlvbnMpOiBTcWxGcmFnIHtcbiAgICAgICAgbGV0IHEgPSBzcWxgSU5TRVJUICR7c3FsLnJhdyhvcHRpb25zPy5pZ25vcmUgPyAnSUdOT1JFICcgOiAnJyl9SU5UTyAke2VzY2FwZUlkKHRhYmxlKX0gU0VUICR7c3FsLnNldChkYXRhIGFzIGFueSl9YDtcbiAgICAgICAgaWYgKG9wdGlvbnM/Lmlnbm9yZUR1cGVzKSB7XG4gICAgICAgICAgICBpZihvcHRpb25zPy51cGRhdGVPbkR1cGUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJgaWdub3JlRHVwZXNgIGFuZCBgdXBkYXRlT25EdXBlYCBhcmUgaW5jb21wYXRpYmxlXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgZmlyc3RDb2w6IElkO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICBmaXJzdENvbCA9IGRhdGFbMF1bMF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZpcnN0Q29sID0gT2JqZWN0LmtleXMoZGF0YSlbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBlc2NDb2wgPSBuZXcgU3FsRnJhZyhfZXNjYXBlSWRMb29zZShmaXJzdENvbCkpO1xuICAgICAgICAgICAgcSA9IHNxbGAke3F9IE9OIERVUExJQ0FURSBLRVkgVVBEQVRFICR7ZXNjQ29sfT1WQUxVRVMoJHtlc2NDb2x9KWA7XG4gICAgICAgIH1cbiAgICAgICAgaWYob3B0aW9ucz8udXBkYXRlT25EdXBlKSB7XG4gICAgICAgICAgICBsZXQgY29sczogSWRbXTtcbiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICBjb2xzID0gZGF0YS5tYXAoZiA9PiBmWzBdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29scyA9IE9iamVjdC5rZXlzKGRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcSA9IHNxbGAke3F9IE9OIERVUExJQ0FURSBLRVkgVVBEQVRFICR7Y29scy5tYXAoY29sID0+e1xuICAgICAgICAgICAgICAgIGNvbnN0IGVzY0NvbCA9IG5ldyBTcWxGcmFnKF9lc2NhcGVJZExvb3NlKGNvbCkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzcWxgJHtlc2NDb2x9PVZBTFVFUygke2VzY0NvbH0pYFxuICAgICAgICAgICAgfSl9YDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcTtcbiAgICB9XG5cbiAgICBleHBvcnQgZnVuY3Rpb24gYXMoZmllbGRzOiBSZWNvcmQ8c3RyaW5nLCBJZD58QXJyYXk8W0lkLHN0cmluZ10+KTogU3FsRnJhZyB7XG4gICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZmllbGRzKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBTcWxGcmFnKGZpZWxkcy5tYXAoZiA9PiBgJHtlc2NhcGVJZChmWzBdKS50b1NxbFN0cmluZygpfSBBUyAke19lc2NhcGVTdHJpbmcoZlsxXSl9YCkuam9pbignLCAnKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBTcWxGcmFnKE9iamVjdC5rZXlzKGZpZWxkcykubWFwKGFsaWFzID0+IGAke19lc2NhcGVJZFN0cmljdChmaWVsZHNbYWxpYXNdKX0gQVMgJHtfZXNjYXBlU3RyaW5nKGFsaWFzKX1gKS5qb2luKCcsICcpKTtcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIHJhdyhzcWxTdHJpbmc6IHN0cmluZyB8IFNxbEZyYWcpOiBTcWxGcmFnIHtcbiAgICAgICAgaWYgKHNxbFN0cmluZyBpbnN0YW5jZW9mIFNxbEZyYWcpIHJldHVybiBzcWxTdHJpbmc7XG4gICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhzcWxTdHJpbmcpO1xuICAgIH1cbiAgICBleHBvcnQgZnVuY3Rpb24gdGltZXN0YW1wKHZhbHVlOiBtb21lbnQuTW9tZW50SW5wdXQsIG91dHB1dFRpbWV6b25lPzogc3RyaW5nIHwgbnVsbCwgaW5wdXRUaW1lem9uZT86IHN0cmluZyB8IG51bGwsIGZzcD86IG51bWJlciB8IG51bGwpOiBTcWxGcmFnIHtcbiAgICAgICAgLy8gaHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL2RhdGUtYW5kLXRpbWUtbGl0ZXJhbHMuaHRtbFxuICAgICAgICAvLyBodHRwczovL21vbWVudGpzLmNvbS9kb2NzLyMvZGlzcGxheWluZy9mb3JtYXQvXG4gICAgICAgIGNvbnN0IGRhdGUgPSBtYWtlTW9tZW50KHZhbHVlLCBvdXRwdXRUaW1lem9uZSwgaW5wdXRUaW1lem9uZSk7XG4gICAgICAgIGxldCBmcmFjID0gJyc7XG4gICAgICAgIGlmIChmc3AgIT0gbnVsbCkge1xuICAgICAgICAgICAgaWYgKGZzcCA8IDAgfHwgZnNwID4gNikge1xuICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZGV2Lm15c3FsLmNvbS9kb2MvcmVmbWFuLzguMC9lbi9kYXRlLWFuZC10aW1lLXR5cGUtb3ZlcnZpZXcuaHRtbFxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZnNwIG91dCBvZiByYW5nZTogJHtmc3B9YCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZzcCA+IDApIHtcbiAgICAgICAgICAgICAgICBmcmFjID0gJy4nICsgJ1MnLnJlcGVhdChmc3ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGRhdGUubWlsbGlzZWNvbmRzKCkgIT09IDApIHtcbiAgICAgICAgICAgIGZyYWMgPSAnLlNTUyc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFNxbEZyYWcoYFRJTUVTVEFNUCcke2RhdGUuZm9ybWF0KGBZWVlZLU1NLUREIEhIOm1tOnNzJHtmcmFjfWApfSdgKVxuICAgIH1cbiAgICBleHBvcnQgZnVuY3Rpb24gcG9pbnQoeDogbnVtYmVyLCB5OiBudW1iZXIpOiBTcWxGcmFnICB7XG4gICAgICAgIHJldHVybiBzcWxgUG9pbnRGcm9tVGV4dCgke2BQT0lOVCgke3h9ICR7eX0pYH0pYDtcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIHBvbHlnb24ocG9pbnRzOiBQb2ludEFycmF5LCBhdXRvQ29tcGxldGUgPSB0cnVlKTogU3FsRnJhZyAge1xuICAgICAgICAvLyBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi81LjcvZW4vZ2lzLWRhdGEtZm9ybWF0cy5odG1sXG4gICAgICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1dlbGwta25vd25fdGV4dF9yZXByZXNlbnRhdGlvbl9vZl9nZW9tZXRyeSNXZWxsLWtub3duX2JpbmFyeVxuICAgICAgICBpZiAoIXBvaW50cy5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjcmVhdGUgYW4gZW1wdHkgcG9seWdvblwiKTtcbiAgICAgICAgcG9pbnRzID0gdG9QYWlycyhwb2ludHMpO1xuICAgICAgICBpZiAoYXV0b0NvbXBsZXRlKSB7XG4gICAgICAgICAgICBjb25zdCBsID0gcG9pbnRzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICBpZiAoIShwb2ludHNbMF1bMF0gPT09IHBvaW50c1tsXVswXSAmJiBwb2ludHNbMF1bMV0gPT09IHBvaW50c1tsXVsxXSkpIHtcbiAgICAgICAgICAgICAgICBwb2ludHMucHVzaChbcG9pbnRzWzBdWzBdLCBwb2ludHNbMF1bMV1dKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3FsYFBvbHlGcm9tVGV4dCgke2BQT0xZR09OKCgke1xuICAgICAgICAgICAgcG9pbnRzLm1hcCgoW3gsIHldKSA9PiBgJHt4fSAke3l9YCkuam9pbignLCcpXG4gICAgICAgIH0pKWB9KWA7XG4gICAgfVxuICAgIGV4cG9ydCBmdW5jdGlvbiBpZChpZDogSWQpOiBTcWxGcmFnIHtcbiAgICAgICAgcmV0dXJuIGVzY2FwZUlkKGlkKVxuICAgIH1cbiAgICBleHBvcnQgZnVuY3Rpb24gZGIoaWQ6IERhdGFiYXNlSWQpOiBTcWxGcmFnIHtcbiAgICAgICAgcmV0dXJuIGVzY2FwZUlkKGlkKVxuICAgIH1cbiAgICBleHBvcnQgZnVuY3Rpb24gdGJsKGlkOiBUYWJsZUlkKTogU3FsRnJhZyB7XG4gICAgICAgIHJldHVybiBlc2NhcGVJZChpZClcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIGNvbChpZDogQ29sdW1uSWQpOiBTcWxGcmFnIHtcbiAgICAgICAgcmV0dXJuIGVzY2FwZUlkKGlkKVxuICAgIH1cbiAgICBleHBvcnQgZnVuY3Rpb24gY29sdW1ucyhjb2x1bW5zOiBJZFtdKTogU3FsRnJhZyB7XG4gICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhjb2x1bW5zLm1hcChfZXNjYXBlSWRTdHJpY3QpLmpvaW4oJywgJykpXG4gICAgfVxuICAgIGV4cG9ydCBmdW5jdGlvbiB2YWx1ZXModmFsdWVzOiBWYWx1ZVtdW10pOiBTcWxGcmFnIHtcbiAgICAgICAgcmV0dXJuIG5ldyBTcWxGcmFnKHZhbHVlcy5tYXAocm93ID0+IGAoJHtyb3cubWFwKF9lc2NhcGVWYWx1ZSkuam9pbignLCcpfSlgKS5qb2luKCcsXFxuJykpXG4gICAgfVxufVxuIl19