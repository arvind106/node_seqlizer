"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConnectionPool = void 0;

var mysql = _interopRequireWildcard(require("mysql"));

var _Sql = require("./Sql");

var _cliHighlight = _interopRequireDefault(require("cli-highlight"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function typeCast(field, next) {
  switch (field.type) {
    case 'DATE':
    case 'DATETIME':
    case 'DATETIME2':
    case 'NEWDATE':
    case 'TIMESTAMP':
    case 'TIMESTAMP2':
      return field.string();

    case 'LONGLONG':
      const numberString = field.string();
      return numberString === null ? null : BigInt(numberString);

    case 'BIT':
      if (field.length === 1) {
        const buf = field.buffer();
        return buf === null ? null : buf[0] === 1;
      }

      break;
  }

  return next();
}

class ConnectionPool {
  constructor(config) {
    this.config = {
      timezone: 'Z',
      charset: 'utf8mb4',
      typeCast,
      ...config
    };
    let {
      sqlMode,
      foreignKeyChecks,
      safeUpdates,
      printQueries,
      initSql,
      ...other
    } = this.config;
    this.pool = mysql.createPool(other);
    const connQueries = initSql ? [...initSql] : [];

    if (sqlMode != null) {
      connQueries.push(_Sql.sql`SET sql_mode=${Array.isArray(sqlMode) ? sqlMode.join(',') : sqlMode}`);
    }

    if (foreignKeyChecks != null) {
      connQueries.push(_Sql.sql`SET foreign_key_checks=${foreignKeyChecks ? 1 : 0}`);
    }

    if (safeUpdates) {
      connQueries.push(_Sql.sql`SET sql_safe_updates=${safeUpdates ? 1 : 0}`);
    }

    if (connQueries.length) {
      this.pool.on('connection', _conn => {
        const conn = this._wrap(_conn);

        for (const query of connQueries) {
          conn.query(query);
        }
      });
    }
  }

  query(query) {
    return this.withConnection(conn => conn.query(query));
  }

  async row(query) {
    const rows = await this.query(_Sql.sql`select * from (${query}) _query limit 1`);
    return rows.length ? rows[0] : null;
  }

  async value(query) {
    const row = await this.row(query);
    if (!row) return null;
    const keys = Object.keys(row);
    if (keys.length !== 1) throw new Error(`Expected exactly 1 field in query, got ${keys.length}`);
    return row[keys[0]];
  }

  async exists(query) {
    return Boolean((await this.value(_Sql.sql`select exists(${query})`)));
  }

  exec(query) {
    return this.withConnection(conn => conn.query(query));
  }

  async *stream(query) {
    const sql = query.toSqlString();

    if (this.config.printQueries) {
      const hisql = (0, _cliHighlight.default)(sql, {
        language: 'sql',
        ignoreIllegals: true
      });
      console.log(hisql);
    }

    let results = [];
    let resolve;
    let promise = new Promise(r => resolve = r);
    let done = false;
    this.pool.query(sql).on('error', err => {
      throw err;
    }).on('result', row => {
      results.push(row);
      resolve();
    }).on('end', () => {
      done = true;
      resolve();
    });

    for (;;) {
      await promise;
      yield* results;
      if (done) break;
      promise = new Promise(r => resolve = r);
      results = [];
    }
  }

  withConnection(callback) {
    return new Promise((resolve, reject) => {
      this.pool.getConnection(async (err, conn) => {
        if (err) return reject(err);

        try {
          resolve(callback(this._wrap(conn)));
        } finally {
          conn.release();
        }
      });
    });
  }

  transaction(callback) {
    if (Array.isArray(callback)) {
      return this.transaction(async conn => {
        const results = await Promise.allSettled(callback.map(sql => conn.query(sql)));
        const mapped = zip(callback, results).map((x, i) => ({
          index: i,
          query: x[0],
          result: x[1]
        }));
        const errors = mapped.filter(r => r.result.status === 'rejected');
        if (errors.length) throw Error(`${errors.length} quer${errors.length === 1 ? 'y' : 'ies'} failed:${errors.map(err => `\n[${err.index}] ${err.query.toSqlString()} :: ${err.result.reason}`).join('')}`);
        return results;
      });
    }

    return this.withConnection(async conn => {
      await conn.query(_Sql.sql`START TRANSACTION`);
      let result;

      try {
        result = await callback(conn);
      } catch (err) {
        await conn.query(_Sql.sql`ROLLBACK`);
        throw err;
      }

      await conn.query(_Sql.sql`COMMIT`);
      return result;
    });
  }

  _wrap(conn) {
    return new PoolConnection(conn, !!this.config.printQueries);
  }

  close() {
    return new Promise((resolve, reject) => {
      this.pool.end(err => {
        if (err) return reject(err);
        resolve();
      });
    });
  }

}

exports.ConnectionPool = ConnectionPool;

function zip(a, b) {
  if (a.length !== b.length) throw new Error("Cannot zip arrays; lengths differ");
  return a.map((x, i) => [x, b[i]]);
}

class PoolConnection {
  constructor(conn, printQueries) {
    this.conn = conn;
    this.printQueries = printQueries;
  }

  query(query) {
    return new Promise((resolve, reject) => {
      const sql = query.toSqlString();

      if (this.printQueries) {
        const hisql = (0, _cliHighlight.default)(sql, {
          language: 'sql',
          ignoreIllegals: true
        });
        console.log(hisql);
      }

      this.conn.query(sql, (error, results, fields) => {
        if (error) return reject(error);
        resolve(results);
      });
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25uZWN0aW9uUG9vbC50cyJdLCJuYW1lcyI6WyJ0eXBlQ2FzdCIsImZpZWxkIiwibmV4dCIsInR5cGUiLCJzdHJpbmciLCJudW1iZXJTdHJpbmciLCJCaWdJbnQiLCJsZW5ndGgiLCJidWYiLCJidWZmZXIiLCJDb25uZWN0aW9uUG9vbCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwidGltZXpvbmUiLCJjaGFyc2V0Iiwic3FsTW9kZSIsImZvcmVpZ25LZXlDaGVja3MiLCJzYWZlVXBkYXRlcyIsInByaW50UXVlcmllcyIsImluaXRTcWwiLCJvdGhlciIsInBvb2wiLCJteXNxbCIsImNyZWF0ZVBvb2wiLCJjb25uUXVlcmllcyIsInB1c2giLCJzcWwiLCJBcnJheSIsImlzQXJyYXkiLCJqb2luIiwib24iLCJfY29ubiIsImNvbm4iLCJfd3JhcCIsInF1ZXJ5Iiwid2l0aENvbm5lY3Rpb24iLCJyb3ciLCJyb3dzIiwidmFsdWUiLCJrZXlzIiwiT2JqZWN0IiwiRXJyb3IiLCJleGlzdHMiLCJCb29sZWFuIiwiZXhlYyIsInN0cmVhbSIsInRvU3FsU3RyaW5nIiwiaGlzcWwiLCJsYW5ndWFnZSIsImlnbm9yZUlsbGVnYWxzIiwiY29uc29sZSIsImxvZyIsInJlc3VsdHMiLCJyZXNvbHZlIiwicHJvbWlzZSIsIlByb21pc2UiLCJyIiwiZG9uZSIsImVyciIsImNhbGxiYWNrIiwicmVqZWN0IiwiZ2V0Q29ubmVjdGlvbiIsInJlbGVhc2UiLCJ0cmFuc2FjdGlvbiIsImFsbFNldHRsZWQiLCJtYXAiLCJtYXBwZWQiLCJ6aXAiLCJ4IiwiaSIsImluZGV4IiwicmVzdWx0IiwiZXJyb3JzIiwiZmlsdGVyIiwic3RhdHVzIiwicmVhc29uIiwiUG9vbENvbm5lY3Rpb24iLCJjbG9zZSIsImVuZCIsImEiLCJiIiwiZXJyb3IiLCJmaWVsZHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7QUFzRUEsU0FBU0EsUUFBVCxDQUFr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TyxDQUFDRCxPQUFELENBQVA7QUFDSCxPQUhEO0FBSUgsS0FWTSxDQUFQO0FBV0g7O0FBbEJnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG15c3FsIGZyb20gJ215c3FsJztcbmltcG9ydCB7UG9vbENvbmZpZyBhcyBfUG9vbENvbmZpZywgUG9vbCwgRmllbGRJbmZvIGFzIF9GaWVsZEluZm99IGZyb20gXCJteXNxbFwiO1xuaW1wb3J0IHtzcWwsIFNxbEZyYWd9IGZyb20gJy4vU3FsJztcbmltcG9ydCBoaWdobGlnaHQgZnJvbSAnY2xpLWhpZ2hsaWdodCc7XG5pbXBvcnQge0dlb21ldHJ5VHlwZX0gZnJvbSBcIm15c3FsXCI7XG5pbXBvcnQgU3FsTW9kZSBmcm9tIFwiLi9TcWxNb2RlXCI7XG5pbXBvcnQge1Bvb2xDb25uZWN0aW9uIGFzIF9Qb29sQ29ubmVjdGlvbn0gZnJvbSBcIm15c3FsXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUG9vbENvbmZpZyBleHRlbmRzIE9taXQ8X1Bvb2xDb25maWcsJ3R5cGVDYXN0J3wnc3VwcG9ydEJpZ051bWJlcnMnfCdiaWdOdW1iZXJTdHJpbmdzJz4ge1xuICAgIC8qKlxuICAgICAqIFByaW50IFNRTCBxdWVyaWVzIHRvIFNURE9VVCBiZWZvcmUgZXhlY3V0aW5nIHRoZW0uXG4gICAgICovXG4gICAgcHJpbnRRdWVyaWVzPzogYm9vbGVhblxuICAgIHR5cGVDYXN0PzogKGZpZWxkOiBGaWVsZEluZm8sIG5leHQ6IE5leHRGbikgPT4gYW55LFxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIFNldCBpbiBteS5jbmYgdW5kZXIgW215c3FsZF1cbiAgICAgKi9cbiAgICBzcWxNb2RlPzogU3FsTW9kZVtdfHN0cmluZ3xudWxsLFxuICAgIC8qKlxuICAgICAqIEVuYWJsZSBvciBkaXNhYmxlIGZvcmVpZ24ga2V5IGNoZWNrcyBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbi4gTWF5IGVhc2UgbWlncmF0aW9uIHNjcmlwdHMsIGJ1dCBub3QgcmVjb21tZW5kZWRcbiAgICAgKiBmb3IgcHJvZHVjdGlvbiB1c2FnZS5cbiAgICAgKi9cbiAgICBmb3JlaWduS2V5Q2hlY2tzPzogYm9vbGVhbnxudWxsLFxuICAgIC8qKlxuICAgICAqIElmIHRoaXMgdmFyaWFibGUgaXMgZW5hYmxlZCwgVVBEQVRFIGFuZCBERUxFVEUgc3RhdGVtZW50cyB0aGF0IGRvIG5vdCB1c2UgYSBrZXkgaW4gdGhlIFdIRVJFIGNsYXVzZSBvciBhIExJTUlUIGNsYXVzZSBwcm9kdWNlIGFuIGVycm9yLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIGNhdGNoIFVQREFURSBhbmQgREVMRVRFIHN0YXRlbWVudHMgd2hlcmUga2V5cyBhcmUgbm90IHVzZWQgcHJvcGVybHkgYW5kIHRoYXQgd291bGQgcHJvYmFibHkgY2hhbmdlIG9yIGRlbGV0ZSBhIGxhcmdlIG51bWJlciBvZiByb3dzLlxuICAgICAqXG4gICAgICogQGxpbmsgaHR0cHM6Ly9tYXJpYWRiLmNvbS9rYi9lbi9saWJyYXJ5L3NlcnZlci1zeXN0ZW0tdmFyaWFibGVzLyNzcWxfc2FmZV91cGRhdGVzXG4gICAgICogQGxpbmsgaHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vOC4wL2VuL3NlcnZlci1zeXN0ZW0tdmFyaWFibGVzLmh0bWwjc3lzdmFyX3NxbF9zYWZlX3VwZGF0ZXNcbiAgICAgKiBAZGVwcmVjYXRlZCBTZXQgaW4gbXkuY25mIHVuZGVyIFtteXNxbGRdXG4gICAgICovXG4gICAgc2FmZVVwZGF0ZXM/OiBib29sZWFufG51bGwsXG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgU1FMIHN0YXRlbWVudHMgdG8gZXhlY3V0ZSB1cG9uIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgaW5pdFNxbD86IEFycmF5PFNxbEZyYWc+XG59XG5cblxuZXhwb3J0IHR5cGUgTmV4dEZuID0gKCkgPT4gdm9pZFxuZXhwb3J0IHR5cGUgVHlwZXMgPSAnREVDSU1BTCd8J1RJTlknfCdTSE9SVCd8J0xPTkcnfCdGTE9BVCd8J0RPVUJMRSd8J05VTEwnfCdUSU1FU1RBTVAnfCdMT05HTE9ORyd8J0lOVDI0J3wnREFURSd8J1RJTUUnfCdEQVRFVElNRSd8J1lFQVInfCdORVdEQVRFJ3wnVkFSQ0hBUid8J0JJVCd8J1RJTUVTVEFNUDInfCdEQVRFVElNRTInfCdUSU1FMid8J0pTT04nfCdORVdERUNJTUFMJ3wnRU5VTSd8J1NFVCd8J1RJTllfQkxPQid8J01FRElVTV9CTE9CJ3wnTE9OR19CTE9CJ3wnQkxPQid8J1ZBUl9TVFJJTkcnfCdTVFJJTkcnfCdHRU9NRVRSWSdcblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZEluZm8ge1xuICAgIGNhdGFsb2c6IHN0cmluZztcbiAgICBkYjogc3RyaW5nO1xuICAgIHRhYmxlOiBzdHJpbmc7XG4gICAgb3JnVGFibGU6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgb3JnTmFtZTogc3RyaW5nO1xuICAgIGNoYXJzZXROcjogbnVtYmVyO1xuICAgIGxlbmd0aDogbnVtYmVyO1xuICAgIHR5cGU6IFR5cGVzO1xuICAgIGZsYWdzOiBudW1iZXI7XG4gICAgZGVjaW1hbHM6IG51bWJlcjtcbiAgICBkZWZhdWx0Pzogc3RyaW5nO1xuICAgIHplcm9GaWxsOiBib29sZWFuO1xuICAgIHByb3RvY29sNDE6IGJvb2xlYW47XG4gICAgc3RyaW5nKCk6IHN0cmluZyB8IG51bGwsXG4gICAgYnVmZmVyKCk6IEJ1ZmZlciB8IG51bGwsXG4gICAgZ2VvbWV0cnkoKTogR2VvbWV0cnlUeXBlIHwgbnVsbCxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPa1BhY2tldCB7XG4gICAgZmllbGRDb3VudDogbnVtYmVyLFxuICAgIGFmZmVjdGVkUm93czogbnVtYmVyLFxuICAgIGluc2VydElkOiBudW1iZXIsXG4gICAgc2VydmVyU3RhdHVzOiBudW1iZXIsXG4gICAgd2FybmluZ0NvdW50OiBudW1iZXIsXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIHByb3RvY29sNDE6IGJvb2xlYW4sXG4gICAgY2hhbmdlZFJvd3M6IG51bWJlclxufVxuXG5cbmZ1bmN0aW9uIHR5cGVDYXN0KGZpZWxkOiBGaWVsZEluZm8sIG5leHQ6IE5leHRGbik6IGFueSB7XG4gICAgc3dpdGNoIChmaWVsZC50eXBlKSB7XG4gICAgICAgIGNhc2UgJ0RBVEUnOlxuICAgICAgICBjYXNlICdEQVRFVElNRSc6XG4gICAgICAgIGNhc2UgJ0RBVEVUSU1FMic6XG4gICAgICAgIGNhc2UgJ05FV0RBVEUnOlxuICAgICAgICBjYXNlICdUSU1FU1RBTVAnOlxuICAgICAgICBjYXNlICdUSU1FU1RBTVAyJzpcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9teXNxbGpzL215c3FsI3R5cGUtY2FzdGluZ1xuICAgICAgICAgICAgcmV0dXJuIGZpZWxkLnN0cmluZygpO1xuICAgICAgICBjYXNlICdMT05HTE9ORyc6XG4gICAgICAgICAgICBjb25zdCBudW1iZXJTdHJpbmcgPSBmaWVsZC5zdHJpbmcoKTtcbiAgICAgICAgICAgIHJldHVybiBudW1iZXJTdHJpbmcgPT09IG51bGwgPyBudWxsIDogQmlnSW50KG51bWJlclN0cmluZyk7XG4gICAgICAgIGNhc2UgJ0JJVCc6XG4gICAgICAgICAgICBpZiAoZmllbGQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYnVmID0gZmllbGQuYnVmZmVyKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGJ1ZiA9PT0gbnVsbCA/IG51bGwgOiBidWZbMF0gPT09IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG4gICAgcmV0dXJuIG5leHQoKTtcbn1cblxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb25Qb29sIHtcbiAgICBwcml2YXRlIHBvb2w6IFBvb2w7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IFBvb2xDb25maWc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFBvb2xDb25maWcpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSB7XG4gICAgICAgICAgICB0aW1lem9uZTogJ1onLFxuICAgICAgICAgICAgY2hhcnNldDogJ3V0ZjhtYjQnLFxuICAgICAgICAgICAgdHlwZUNhc3QsXG4gICAgICAgICAgICAuLi5jb25maWcsXG4gICAgICAgIH07XG4gICAgICAgIGxldCB7c3FsTW9kZSxmb3JlaWduS2V5Q2hlY2tzLHNhZmVVcGRhdGVzLHByaW50UXVlcmllcyxpbml0U3FsLC4uLm90aGVyfSA9IHRoaXMuY29uZmlnO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhvdGhlcik7XG4gICAgICAgIHRoaXMucG9vbCA9IG15c3FsLmNyZWF0ZVBvb2wob3RoZXIpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5RdWVyaWVzID0gaW5pdFNxbCA/IFsuLi5pbml0U3FsXSA6IFtdO1xuICAgICAgICBpZihzcWxNb2RlICE9IG51bGwpIHtcbiAgICAgICAgICAgIGNvbm5RdWVyaWVzLnB1c2goc3FsYFNFVCBzcWxfbW9kZT0ke0FycmF5LmlzQXJyYXkoc3FsTW9kZSkgPyAgc3FsTW9kZS5qb2luKCcsJykgOiBzcWxNb2RlfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmKGZvcmVpZ25LZXlDaGVja3MgIT0gbnVsbCkge1xuICAgICAgICAgICAgY29ublF1ZXJpZXMucHVzaChzcWxgU0VUIGZvcmVpZ25fa2V5X2NoZWNrcz0ke2ZvcmVpZ25LZXlDaGVja3MgPyAxIDogMH1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZihzYWZlVXBkYXRlcykge1xuICAgICAgICAgICAgY29ublF1ZXJpZXMucHVzaChzcWxgU0VUIHNxbF9zYWZlX3VwZGF0ZXM9JHtzYWZlVXBkYXRlcyA/IDEgOiAwfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmKGNvbm5RdWVyaWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5wb29sLm9uKCdjb25uZWN0aW9uJywgKF9jb25uOiBfUG9vbENvbm5lY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb25uID0gdGhpcy5fd3JhcChfY29ubik7XG4gICAgICAgICAgICAgICAgZm9yKGNvbnN0IHF1ZXJ5IG9mIGNvbm5RdWVyaWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm4ucXVlcnkocXVlcnkpOyAvLyBUT0RPOiBkbyB3ZSBuZWVkIHRvIHdhaXQgZm9yIHRoZXNlIHF1ZXJpZXMgdG8gZmluaXNoLi4uP1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcXVlcnk8VFJlY29yZCBleHRlbmRzIG9iamVjdD1SZWNvcmQ8c3RyaW5nLGFueT4+KHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxUUmVjb3JkW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aENvbm5lY3Rpb24oY29ubiA9PiBjb25uLnF1ZXJ5KHF1ZXJ5KSlcbiAgICB9XG5cbiAgICBhc3luYyByb3c8VFJlY29yZCBleHRlbmRzIG9iamVjdD1SZWNvcmQ8c3RyaW5nLGFueT4+KHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxUUmVjb3JkfG51bGw+IHtcbiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHRoaXMucXVlcnk8VFJlY29yZD4oc3FsYHNlbGVjdCAqIGZyb20gKCR7cXVlcnl9KSBfcXVlcnkgbGltaXQgMWApXG4gICAgICAgIHJldHVybiByb3dzLmxlbmd0aCA/IHJvd3NbMF0gOiBudWxsO1xuICAgIH1cblxuICAgIGFzeW5jIHZhbHVlPFRWYWx1ZT1zdHJpbmc+KHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxUVmFsdWV8bnVsbD4ge1xuICAgICAgICBjb25zdCByb3cgPSBhd2FpdCB0aGlzLnJvdyhxdWVyeSlcbiAgICAgICAgaWYoIXJvdykgcmV0dXJuIG51bGxcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHJvdylcbiAgICAgICAgaWYoa2V5cy5sZW5ndGggIT09IDEpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgZXhhY3RseSAxIGZpZWxkIGluIHF1ZXJ5LCBnb3QgJHtrZXlzLmxlbmd0aH1gKVxuICAgICAgICByZXR1cm4gcm93W2tleXNbMF1dXG4gICAgfVxuXG4gICAgYXN5bmMgZXhpc3RzKHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBCb29sZWFuKGF3YWl0IHRoaXMudmFsdWU8MHwxPihzcWxgc2VsZWN0IGV4aXN0cygke3F1ZXJ5fSlgKSlcbiAgICB9XG5cbiAgICBleGVjKHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxPa1BhY2tldD4ge1xuICAgICAgICByZXR1cm4gdGhpcy53aXRoQ29ubmVjdGlvbihjb25uID0+IGNvbm4ucXVlcnkocXVlcnkpKVxuICAgIH1cblxuICAgIGFzeW5jKiBzdHJlYW08VFJlY29yZCBleHRlbmRzIG9iamVjdCA9IFJlY29yZDxzdHJpbmcsIGFueT4+KHF1ZXJ5OiBTcWxGcmFnKTogQXN5bmNHZW5lcmF0b3I8VFJlY29yZCwgdm9pZCwgYW55PiB7XG4gICAgICAgIGNvbnN0IHNxbCA9IHF1ZXJ5LnRvU3FsU3RyaW5nKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLnByaW50UXVlcmllcykge1xuICAgICAgICAgICAgY29uc3QgaGlzcWwgPSBoaWdobGlnaHQoc3FsLCB7bGFuZ3VhZ2U6ICdzcWwnLCBpZ25vcmVJbGxlZ2FsczogdHJ1ZX0pO1xuICAgICAgICAgICAgY29uc29sZS5sb2coaGlzcWwpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlc3VsdHM6IFRSZWNvcmRbXSA9IFtdO1xuICAgICAgICBsZXQgcmVzb2x2ZTogKCkgPT4gdm9pZDtcbiAgICAgICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZShyID0+IHJlc29sdmUgPSByKTtcbiAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLnBvb2wucXVlcnkoc3FsKVxuICAgICAgICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5vbigncmVzdWx0Jywgcm93ID0+IHtcbiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocm93KTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICBmb3IoOzspIHtcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2U7XG4gICAgICAgICAgICB5aWVsZCogcmVzdWx0cztcbiAgICAgICAgICAgIGlmKGRvbmUpIGJyZWFrXG4gICAgICAgICAgICBwcm9taXNlID0gbmV3IFByb21pc2UociA9PiByZXNvbHZlID0gcik7XG4gICAgICAgICAgICByZXN1bHRzID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB3aXRoQ29ubmVjdGlvbjxUUmVzdWx0PihjYWxsYmFjazogKGNvbm46UG9vbENvbm5lY3Rpb24pID0+IFByb21pc2U8VFJlc3VsdD4pOiBQcm9taXNlPFRSZXN1bHQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucG9vbC5nZXRDb25uZWN0aW9uKGFzeW5jIChlcnIsIGNvbm4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShjYWxsYmFjayh0aGlzLl93cmFwKGNvbm4pKSk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgY29ubi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHJhbnNhY3Rpb248VFJlc3VsdD4oY2FsbGJhY2s6ICgoY29ubjpQb29sQ29ubmVjdGlvbikgPT4gUHJvbWlzZTxUUmVzdWx0Pil8U3FsRnJhZ1tdKTogUHJvbWlzZTxUUmVzdWx0PiB7XG4gICAgICAgIGlmKEFycmF5LmlzQXJyYXkoY2FsbGJhY2spKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbjxhbnk+KGFzeW5jIGNvbm4gPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoY2FsbGJhY2subWFwKHNxbCA9PiBjb25uLnF1ZXJ5KHNxbCkpKVxuICAgICAgICAgICAgICAgIGNvbnN0IG1hcHBlZCA9IHppcChjYWxsYmFjaywgcmVzdWx0cykubWFwKCh4LGkpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiBpLFxuICAgICAgICAgICAgICAgICAgICBxdWVyeTogeFswXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB4WzFdLFxuICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IG1hcHBlZC5maWx0ZXIociA9PiByLnJlc3VsdC5zdGF0dXMgPT09ICdyZWplY3RlZCcpO1xuICAgICAgICAgICAgICAgIGlmKGVycm9ycy5sZW5ndGgpIHRocm93IEVycm9yKGAke2Vycm9ycy5sZW5ndGh9IHF1ZXIke2Vycm9ycy5sZW5ndGggPT09IDEgPyAneScgOiAnaWVzJ30gZmFpbGVkOiR7ZXJyb3JzLm1hcChlcnIgPT4gYFxcblske2Vyci5pbmRleH1dICR7ZXJyLnF1ZXJ5LnRvU3FsU3RyaW5nKCl9IDo6ICR7KGVyci5yZXN1bHQgYXMgYW55KS5yZWFzb259YCkuam9pbignJyl9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7IC8vIFRPRE86IGlzIHRoaXMgdGhlIGJlc3QgZm9ybWF0IGZvciB0aGUgcmVzdWx0cz9cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLndpdGhDb25uZWN0aW9uKGFzeW5jIGNvbm4gPT4ge1xuICAgICAgICAgICAgYXdhaXQgY29ubi5xdWVyeShzcWxgU1RBUlQgVFJBTlNBQ1RJT05gKTsgIC8vIFRPRE86IGNoYW5nZSB0byBleGVjXG4gICAgICAgICAgICBsZXQgcmVzdWx0OiBUUmVzdWx0O1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBjYWxsYmFjayhjb25uKTtcbiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgY29ubi5xdWVyeShzcWxgUk9MTEJBQ0tgKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCBjb25uLnF1ZXJ5KHNxbGBDT01NSVRgKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd3JhcChjb25uOiBfUG9vbENvbm5lY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQb29sQ29ubmVjdGlvbihjb25uLCAhIXRoaXMuY29uZmlnLnByaW50UXVlcmllcyk7XG4gICAgfVxuXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnBvb2wuZW5kKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxufVxuXG5mdW5jdGlvbiB6aXA8QSxCPihhOiBBW10sIGI6IEJbXSk6IEFycmF5PFtBLEJdPiB7XG4gICAgaWYoYS5sZW5ndGggIT09IGIubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgemlwIGFycmF5czsgbGVuZ3RocyBkaWZmZXJcIik7XG4gICAgcmV0dXJuIGEubWFwKCh4LGkpID0+IFt4LGJbaV1dKTtcbn1cblxuY2xhc3MgUG9vbENvbm5lY3Rpb24ge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb25uOiBfUG9vbENvbm5lY3Rpb24sIHByaXZhdGUgcmVhZG9ubHkgcHJpbnRRdWVyaWVzOiBib29sZWFuKSB7XG5cbiAgICB9XG5cbiAgICBxdWVyeShxdWVyeTogU3FsRnJhZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzcWwgPSBxdWVyeS50b1NxbFN0cmluZygpO1xuICAgICAgICAgICAgaWYgKHRoaXMucHJpbnRRdWVyaWVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGlzcWwgPSBoaWdobGlnaHQoc3FsLCB7bGFuZ3VhZ2U6ICdzcWwnLCBpZ25vcmVJbGxlZ2FsczogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGhpc3FsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY29ubi5xdWVyeShzcWwsIChlcnJvciwgcmVzdWx0cywgZmllbGRzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBhZGQgYWxsIHRoZSBvdGhlciBxdWVyeSBtZXRob2RzIGZyb20gQ29ubmVjdGlvblBvb2w7IGZpZ3VyZSBvdXQgaG93IHRvIHNoYXJlIHRoZW1cbn1cbiJdfQ==